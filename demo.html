<html>
	<head>
		<meta http-equiv="Content-type" content="text/html; charset=utf-8">
		<title>opening_hours demo</title>
		<script src="opening_hours.js"></script>
		<style>
			body { font-family: sans-serif }
			table {}
			tr.today td { border-top: 2px solid #BBBBCC }
			tr.today td.day { font-weight: bold }
			td { background: #E0E0E0; padding: 0px 10px }
			td.day { text-align: center }
			td.workday { background: #CCFF99 }
			td.weekend { background: #FFCC99 }
			td.times { width: 400px; padding: 0px 1px }

			div.timebar { height: 20px; display: inline-block }
			div.open { background: #FFFFFF; margin: 0px -1px; border: 1px solid #AAAAAA; border-radius: 5px }
			div.closed {}
			p.open { color: #44AA00 }
			p.closed { color: #AA4400 }
		</style>
	</head>
	<body>
		<script>
			var months = ['Янв','Фев','Мар','Апр','Май','Июн','Июл','Авг','Сен','Окт','Ноя','Дек'];
			var weekdays = ['Вс','Пн','Вт','Ср','Чт','Пт','Сб'];

			var examples = [
				'Mo-Fr 10:00-20:00',
				'Mo,Tu,Th,Fr 12:00-18:00;Sa 12:00-17:00; Th[3] off; Th[-1] off',
				'00:00-24:00; Tu-Su 08:30-09:00 off; Tu-Su 14:00-14:30 off; Mo 08:00-13:00 off',
			];

			var now = new Date();

			for (var e in examples) {
				document.write('<h1>' + examples[e] + '</h1>');
				var oh = new opening_hours(examples[e]);
				var isopen = oh.getState(now);
				var nextchange = oh.getNextChange(now);
				var delta = Math.floor((nextchange.getTime() - now.getTime()) / 1000 / 60);

				var deltastr = (delta % 60) + ' ' + plural(delta % 60, 'минуту', 'минуты', 'минут');
				delta = Math.floor(delta / 60);

				if (delta > 0) {
					deltastr = (delta % 24) + ' ' + plural(delta % 24, 'час', 'часа', 'часов') + ' ' + deltastr;
					delta = Math.floor(delta / 24);
				}

				if (delta > 0) {
					deltastr = delta.toFixed(0) + ' ' + plural(delta, 'день', 'дня', 'дней') + ' ' + deltastr;
				}

				if (isopen) {
					document.write('<p class="open">Сейчас заведение открыто</p>');
					document.write('<p>Закроется ' + nextchange + ' (через ' + deltastr + ')</p>');
				} else {
					document.write('<p class="closed">Сейчас заведение закрыто</p>');
					document.write('<p>Откроется ' + nextchange + ' (через ' + deltastr + ')</p>');
				}

				drawTable(oh, now);

				if (oh.isWeekStable())
					document.write('<p><b>Расписание верно для любой недели.</b></p>');
				else
					document.write('<p><b>ВНИМАНИЕ! Расписание меняется в другие недели.</b></p>');
			}

			function pad(n) { return n < 10 ? '0'+n : n; };

			function plural(n, one, several, many) {
				if (n % 10 >= 5 || n % 10 == 0 || (n % 100 >= 10 && n % 100 < 20)) {
					return many;
				} else if (n % 10 < 2) {
					return one;
				}
				return several;
			}

			function drawTable(oh, date_today) {
				var date_today = new Date(date_today);
				date_today.setHours(0, 0, 0, 0);

				var date = new Date(date_today);
				date.setDate(date.getDate() - date.getDay() + 7);

				var table = [];

				for (var row = 0; row < 7; row++) {
					date.setDate(date.getDate()+1);
					if (date.getDay() == date_today.getDay()) {
						date.setDate(date.getDate()-7);
					}

					var state = oh.getState(date);
					var prevdate = date;
					var curdate = date;

					table[row] = {
						date: new Date(date),
						times: '',
						text: []
					};

					while (curdate.getTime() - date.getTime() < 24*60*60*1000) {
						curdate = oh.getNextChange(curdate);

						var fr = prevdate.getTime() - date.getTime();
						var to = curdate.getTime() - date.getTime();

						if (to > 24*60*60*1000)
							to = 24*60*60*1000;

						fr *= 100/1000/60/60/24;
						to *= 100/1000/60/60/24;

						table[row].times += '<div class="timebar ' + (state?'open':'closed') + '" style="width:' + (to-fr) + '%"></div>';
						if (state) {
							table[row].text.push('с ' + prevdate.getHours() + ':' + pad(prevdate.getMinutes()) + ' до ' + curdate.getHours() + ':' + pad(curdate.getMinutes()));
						}

						prevdate = curdate;
						state = !state;
					}
				}

				document.write('<table>');
				for (var row in table) {
					document.write('<tr' + (table[row].date.getDay() == date_today.getDay() ? ' class="today"' : '') + '><td class="day ' + (table[row].date.getDay() % 6 == 0 ? 'weekend' : 'workday') + '">');
					document.write(months[table[row].date.getMonth()] + ' ' + table[row].date.getDate() + ', ' + weekdays[table[row].date.getDay()]);
					document.write('</td><td class="times">');
					document.write(table[row].times);
					document.write('</td><td>');
					document.write(table[row].text.join(', '));
					document.write('</td></tr>');
				}
				document.write('</table>');
			}
		</script>
	</body>
</html>
